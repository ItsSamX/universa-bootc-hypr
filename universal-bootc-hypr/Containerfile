FROM quay.io/fedora/fedora-bootc:41

LABEL ostree.bootable="true" \
      bootc.version="1" \
      org.opencontainers.image.title="Universal Hyprland bootc" \
      org.opencontainers.image.description="General-purpose immutable Fedora Hyprland desktop"

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# 1. Firmware & hardware support
RUN dnf install -y \
    linux-firmware \
    pciutils \
    usbutils \
    && dnf clean all

# 2. Core system services
RUN dnf install -y \
    NetworkManager \
    bluez \
    tlp \
    seatd \
    polkit \
    polkit-gnome \
    xorg-x11-server-Xwayland \
    xdg-user-dirs \
    flatpak \
    xdg-desktop-portal \
    blueman \
    && dnf clean all

# Enable services
RUN systemctl enable \
    NetworkManager \
    bluetooth \
    tlp \
    seatd

# 3. GUI Layer (Hyprland)
RUN dnf install -y \
    hyprland \
    xdg-desktop-portal-hyprland \
    waybar \
    rofi-wayland \
    dunst \
    swww \
    alacritty \
    sddm \
    && dnf clean all

# Enable SDDM and set default graphical target
RUN systemctl enable sddm \
    && systemctl set-default graphical.target

# Wayland session entry
RUN mkdir -p /usr/share/wayland-sessions && \
    echo -e "[Desktop Entry]\nName=Hyprland\nExec=Hyprland\nType=Application" \
    > /usr/share/wayland-sessions/hyprland.desktop

# 4. Host tools
RUN dnf install -y \
    podman \
    distrobox \
    git \
    just \
    fish \
    neovim \
    && dnf clean all

# 5. User defaults
COPY config/ /etc/skel/.config/
RUN chmod -R 755 /etc/skel/.config
RUN echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel
